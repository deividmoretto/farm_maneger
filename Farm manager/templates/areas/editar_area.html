{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h2 class="mb-0">Editar Área</h2>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('editar_area', id=area.id) }}">
                        <div class="form-group mb-3">
                            <label class="form-label">Nome da Área</label>
                            <input type="text" name="nome" value="{{ area.nome }}" class="form-control" required>
                        </div>

                        <div class="form-group mb-3">
                            <label class="form-label">Cultura</label>
                            <input type="text" name="cultura" value="{{ area.cultura }}" class="form-control">
                        </div>

                        <div class="form-group mb-3">
                            <label class="form-label">Tamanho (hectares)</label>
                            <input type="number" step="0.01" name="tamanho" value="{{ area.tamanho }}" class="form-control" required>
                        </div>

                        <div class="form-group mb-3">
                            <label class="form-label">Endereço</label>
                            <div class="input-group">
                                <input type="text" id="endereco" name="endereco" value="{{ area.endereco }}" class="form-control">
                                <button type="button" id="btnBuscarEndereco" class="btn btn-primary">
                                    <i class="fas fa-search"></i> Buscar
                                </button>
                            </div>
                        </div>
                        
                        <div id="mapContainer" class="mb-3" style="position: relative; z-index: 1; height: 350px; border: 1px solid #ddd; border-radius: 4px; overflow: hidden;">
                            <div id="map" style="width: 100%; height: 100%;"></div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Latitude</label>
                                <input type="text" id="latitude" name="latitude" value="{{ area.latitude }}" class="form-control">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Longitude</label>
                                <input type="text" id="longitude" name="longitude" value="{{ area.longitude }}" class="form-control">
                            </div>
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="{{ url_for('areas') }}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Voltar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Salvar Alterações
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<style>
    /* Reset básico para evitar conflitos com outros estilos */
    #mapContainer * {
        box-sizing: content-box;
    }
    
    /* Configurações para o mapa Leaflet */
    .leaflet-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #f2f2f2;
        z-index: 1;
    }
    
    /* Corrigir posicionamento dos tiles */
    .leaflet-tile-container {
        pointer-events: none;
        position: absolute;
        will-change: transform;
        left: 0;
        top: 0;
    }
    
    .leaflet-tile {
        position: absolute !important;
        left: 0;
        top: 0;
        width: 256px !important;
        height: 256px !important;
    }
    
    /* Remover bordas brancas entre tiles */
    .leaflet-tile-loaded {
        visibility: inherit;
        margin: 0 !important;
        padding: 0 !important;
        border: 0 !important;
    }
    
    /* Garantir que elementos do mapa estejam acima de outros elementos */
    .leaflet-pane,
    .leaflet-overlay-pane,
    .leaflet-marker-pane,
    .leaflet-shadow-pane,
    .leaflet-tooltip-pane,
    .leaflet-popup-pane,
    .leaflet-zoom-box,
    .leaflet-image-layer,
    .leaflet-layer {
        position: absolute;
        left: 0;
        top: 0;
        z-index: auto;
    }
    
    /* Evitar quebras em containers responsivos */
    .leaflet-container .leaflet-overlay-pane svg,
    .leaflet-container .leaflet-marker-pane img,
    .leaflet-container .leaflet-shadow-pane img,
    .leaflet-container .leaflet-tile-pane img,
    .leaflet-container img.leaflet-image-layer,
    .leaflet-container .leaflet-tile {
        max-width: none !important;
        max-height: none !important;
    }
</style>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" 
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
    // Inicializar mapa
    let map = null;
    let marker = null;
    let defaultLocation = [-15.7801, -47.9292]; // Brasília como localização padrão
    
    // Inicializar o mapa com as coordenadas fornecidas
    function initMap(lat, lng) {
        console.log("Inicializando mapa com coordenadas:", lat, lng);
        
        // Se o mapa já existe, destruí-lo para evitar problemas
        if (map) {
            map.remove();
            map = null;
        }
        
        try {
            // Inicializar mapa com opções otimizadas
            map = L.map('map', {
                center: [lat, lng],
                zoom: 13,
                maxZoom: 18,
                minZoom: 2,
                worldCopyJump: true,
                fadeAnimation: false,
                zoomAnimation: false,
                markerZoomAnimation: false,
                preferCanvas: true,
                renderer: L.canvas()
            });
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                subdomains: ['a', 'b', 'c'],
                tileSize: 256,
                updateWhenIdle: true,
                updateWhenZooming: false,
                keepBuffer: 2
            }).addTo(map);
            
            // Adicionar marcador
            marker = L.marker([lat, lng], {draggable: true}).addTo(map);
            
            // Atualizar coordenadas quando o marcador for arrastado
            marker.on('dragend', function(e) {
                let position = marker.getLatLng();
                document.getElementById('latitude').value = position.lat.toFixed(6);
                document.getElementById('longitude').value = position.lng.toFixed(6);
            });
            
            // Corrigir layout após inicialização do mapa
            setTimeout(function() {
                map.invalidateSize(true);
            }, 100);
            
            setTimeout(function() {
                map.invalidateSize(true);
            }, 500);
            
            console.log("Mapa inicializado com sucesso");
        } catch (error) {
            console.error("Erro ao inicializar mapa:", error);
            alert("Erro ao carregar o mapa. Tente recarregar a página.");
        }
    }
    
    // Função para buscar endereço
    function buscarEndereco() {
        const endereco = document.getElementById('endereco').value.trim();
        
        if (!endereco) {
            alert('Por favor, informe um endereço para buscar.');
            return;
        }
        
        // Mostrar indicador de carregamento
        document.getElementById('btnBuscarEndereco').innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Buscando...';
        document.getElementById('btnBuscarEndereco').disabled = true;
        
        // Chamar API de geocodificação
        fetch('/api/geocode', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ endereco: endereco })
        })
        .then(response => response.json())
        .then(data => {
            // Restaurar botão
            document.getElementById('btnBuscarEndereco').innerHTML = '<i class="fas fa-search"></i> Buscar';
            document.getElementById('btnBuscarEndereco').disabled = false;
            
            if (data.error) {
                alert(data.error);
                return;
            }
            
            try {
                // Preencher campos de latitude e longitude
                document.getElementById('latitude').value = data.latitude;
                document.getElementById('longitude').value = data.longitude;
                
                // Atualizar input de endereço com nome mais completo
                document.getElementById('endereco').value = data.display_name || data.endereco;
                
                // Atualizar o mapa com as novas coordenadas
                const lat = parseFloat(data.latitude);
                const lng = parseFloat(data.longitude);
                
                // Verificar se o mapa já existe
                if (map) {
                    // Garantir que o mapa seja redimensionado corretamente
                    map.invalidateSize(true);
                    
                    // Mover o marcador e centralizar o mapa
                    marker.setLatLng([lat, lng]);
                    map.setView([lat, lng], 15);
                } else {
                    // Se o mapa não existir, inicializar
                    initMap(lat, lng);
                }
                
                alert('Localização encontrada com sucesso!');
            } catch (error) {
                console.error('Erro ao processar coordenadas:', error);
                alert('Ocorreu um erro ao processar as coordenadas. Tente novamente.');
            }
        })
        .catch(error => {
            console.error('Erro ao buscar endereço:', error);
            document.getElementById('btnBuscarEndereco').innerHTML = '<i class="fas fa-search"></i> Buscar';
            document.getElementById('btnBuscarEndereco').disabled = false;
            alert('Ocorreu um erro ao buscar o endereço. Tente novamente.');
        });
    }
    
    // Inicialização quando a página carrega
    document.addEventListener('DOMContentLoaded', function() {
        try {
            const latitude = document.getElementById('latitude').value;
            const longitude = document.getElementById('longitude').value;
            
            if (latitude && longitude && !isNaN(parseFloat(latitude)) && !isNaN(parseFloat(longitude))) {
                // Se temos coordenadas válidas, inicializar o mapa com elas
                initMap(parseFloat(latitude), parseFloat(longitude));
            } else {
                // Caso contrário, inicializar com a localização padrão
                initMap(defaultLocation[0], defaultLocation[1]);
            }
            
            // Adicionar evento ao botão de busca
            document.getElementById('btnBuscarEndereco').addEventListener('click', buscarEndereco);
            
            // Permitir busca ao pressionar Enter no campo de endereço
            document.getElementById('endereco').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    buscarEndereco();
                }
            });
            
            // Eventos para corrigir o mapa quando necessário
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden && map) {
                    map.invalidateSize(true);
                }
            });
            
            window.addEventListener('resize', function() {
                if (map) {
                    map.invalidateSize(true);
                }
            });
            
            // Corrigir o mapa novamente após um curto intervalo
            setTimeout(function() {
                if (map) {
                    map.invalidateSize(true);
                }
            }, 2000);
        } catch (error) {
            console.error('Erro durante inicialização:', error);
        }
    });
</script>
{% endblock %} 